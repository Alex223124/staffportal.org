- title "MSP | DMPD Statistics Summary"
%section.intro-box.margin-80.hidden-print
  .container
    .row
      .span12
        %h3.pull-right.hidden-phone= current_user.name
        %ul.breadcrumb
          %li
            %a{:href => root_path} Home
            %span.divider /
          %li
            %a{:href => staff_dmpd_root_path} DMPD
            %span.divider /
          %li.active
            Statistics
        %span.arrow.hidden-phone
.white
  .container
    %h1.page-header
      Statistics
      .pull-right
        %a.btn.btn-primary{href: staff_dmpd_stats_appointment_set_record_index_path} Appointment Set Record
        %a.btn.btn-primary{href: staff_dmpd_stats_support_raising_development_index_path} Weekly Calling Chart
        %a.btn.btn-primary{href: staff_dmpd_stats_contact_card_box_index_path} Contact Card Box
        %br.visible-desktop

    %ul.nav.nav-tabs
      %li.active
        %a{"data-toggle" => "tab", href: "#ss"} Statistics Summary
      %li
        %a{"data-toggle" => "tab", href: "#cr"} Contact Ratio
    .tab-content
      #ss.tab-pane.active
        %table.table.table-striped
          %thead
            %tr
              %th.gray Week Ending
              %th.visible-desktop Total Hours Calling
              %th.visible-desktop Total # of Dials
              %th.visible-desktop # Responses to Appt Ask
              %th.visible-desktop Got Appt Time &amp; Place
              %th.visible-desktop.orange % Giving Appts
              %th.visible-desktop # Y/N Decisions
              %th.visible-desktop # Y to Reccuring
              %th.orange % Y to Reccuring
              %th Total Monthly Pledge
              %th.orange Average Monthly Pledge
              %th Total Special Pledge
              %th.orange Contact Ratio
          %tbody
            - stat_totals = [0, 0, 0, 0, 0, 0, 0, 0]
            - @weeks.each do |wk|
              - srd = current_user.support_raising_developments.find_by_week_id(wk.id)
              - ccb = current_user.contact_card_box.find_by_week_id(wk.id)
              - contacts_received = current_user.appointment_set_record.where(date_set_week_id: wk.id).sum(:number_of_contacts_received)
              - appointments_set = current_user.appointment_set_record.where(date_set_week_id: wk.id).count
              - appointments_had = current_user.appointment_set_record.where(date_of_appointment_week_id: wk.id).count
              - appointments_support = current_user.appointment_set_record.where("date_of_appointment_week_id = ? and frequency > 0", wk.id).count
              - monthly = current_user.appointment_set_record.where("date_of_appointment_week_id = ? and frequency > 0", wk.id).sum(:monthly)
              - special = current_user.appointment_set_record.where("date_of_appointment_week_id = ? and frequency = 0", wk.id).sum(:amount)
              - ratio = number_with_precision(contacts_received.to_d / ccb.contact_ratio_total.to_d, :precision => 2)
              %tr
                - if ccb.nil? or srd.nil?
                  %td.gray
                    %strong= "#{wk.date_finished.strftime('%d %b')}"
                  %td{colspan: "12"}
                    .text-center
                      There is insufficient data to calculate your weekly stats this week.
                      %a{:href => new_staff_dmpd_stats_contact_card_box_path} Add your contact card box statistics
                      or
                      %a{:href => new_staff_dmpd_stats_support_raising_development_path} add your calling chart statistics.
                - else
                  %td.gray
                    %strong= "#{wk.date_finished.strftime('%d %b')}"
                  %td.visible-desktop= srd.hours_calling
                  - stat_totals[0] += srd.hours_calling
                  %td.visible-desktop= srd.number_of_calls_made
                  - stat_totals[1] += srd.number_of_calls_made
                  %td.visible-desktop= ccb.new_ministry_partner + ccb.appointment_no_support
                  - stat_totals[2] += ccb.new_ministry_partner + ccb.appointment_no_support
                  %td.visible-desktop= appointments_set
                  - stat_totals[3] += appointments_set
                  %td.visible-desktop.orange= "#{number_with_precision((appointments_set.to_d / (ccb.new_ministry_partner + ccb.appointment_no_support)) * 100, :precision => 0)}%"
                  %td.visible-desktop= appointments_had
                  - stat_totals[4] += appointments_had
                  %td.visible-desktop= appointments_support
                  - stat_totals[5] += appointments_support
                  %td.orange= "#{number_with_precision((appointments_support.to_d / appointments_had.to_d) * 100, :precision => 0)}%"
                  %td= "#{number_to_currency monthly}/mo"
                  - stat_totals[6] += monthly
                  %td.orange= "#{number_to_currency (monthly / appointments_support)}/mo"
                  %td= number_to_currency special
                  - stat_totals[7] += special
                  %td.orange= ratio


            %tr.totals
              %td.gray
                %strong Totals
              %td= stat_totals[0]
              %td= stat_totals[1]
              %td= stat_totals[2]
              %td= stat_totals[3]
              %td.visible-desktop.orange= "#{number_with_precision((stat_totals[3].to_d / stat_totals[2]) * 100, :precision => 0)}%"
              %td= stat_totals[4]
              %td= stat_totals[5]
              %td.orange= "#{number_with_precision((stat_totals[5].to_d / stat_totals[4].to_d) * 100, :precision => 0)}%"
              %td= "#{number_to_currency stat_totals[6]}/mo"
              %td.orange= "#{number_to_currency (stat_totals[6] / stat_totals[5])}/mo"
              %td= number_to_currency stat_totals[7]
              %td.orange
      #cr.tab-pane
        %table.table.table-striped
          %thead
            %tr
              %th Week
              %th Used
              %th Received
              %th.orange Ratio
          %tbody
            - @weeks.each do |wk|
              - ccb = current_user.contact_card_box.find_by_week_id(wk.id)
              - contacts_received = current_user.appointment_set_record.where(date_set_week_id: wk.id).sum(:number_of_contacts_received)
              %tr
                - if ccb.nil?
                  %td= wk.name
                  %td{colspan: "3"}
                    .text-center
                      There is insufficient data to calculate the contact ratio this week.
                      %a{:href => new_staff_dmpd_stats_contact_card_box_path} Add your contact card box statistics.
                - else
                  %td= wk.name
                  %td= ccb.contact_ratio_total
                  %td= contacts_received
                  %td.orange= number_with_precision(contacts_received.to_d / ccb.contact_ratio_total.to_d, :precision => 2)
